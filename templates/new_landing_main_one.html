{% extends 'base.html' %}
{% load static %}


{% block content %}

    <style>


        #landing_header:hover{
            color: black;
            transform: scale(1.1);
            transition: all ease 500ms;
        }

        #demo_link:hover{
            font-weight: bold;
        }


        #second_section_main_div, #third_section_main_div{
            padding-left: 8em;
            padding-right: 8em;
            padding-top: 4em;
            padding-bottom: 4em;
        }

        #primary_lp_section_divider{
            padding-top: 4em;
        }


        #lp_section_divider_header_div{
            background-color: black;
            width: 110%;
        }

        #lp_section_divider_header_div > h2{
            font-family: 'Raleway', sans-serif;
            text-align: center;
            font-size: 38px;
        }

        #lp_section_divider_header_div > h2:hover{
            color: #6f1ee1;
        }

        /* #lp_section_divider_header_div > h2:hover{
            color: #6f1ee1;
        } */

        /* #main_first_column{
            margin-bottom: 0%
        } */


        #vertical_section_list > .item{    
            margin: 5px 0;    
            /* font-weight: 700; */
        }

        #vertical_section_list > .item .content .description{    
            font-size: 15px;
            line-height: 1.4em; 
            letter-spacing: 0.1px;
            color: rgba(0, 0, 0, 0.87);
            /* font-weight: 700;  */
            /* color: #181818; */
            /* color: #4c4c4c; */
        }



        /* Chat Container */
        #code-column{
            padding-top: 27px;
            padding-left: 25px;
        }

        .input-container {
            display: flex;
            margin-top: 20px;            
        }

        h4{
            font-family: 'Raleway', sans-serif;
        }

        .chat-container {
            height: 520px;
            border: 1px solid #ccc;
            border-radius: 10px;
            overflow-y: auto;
            padding: 15px;
            margin-top: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f2f2f2;
            border-radius: 10px;
        }

        .input-box {
            padding: 10px;
            border-radius: 5px;
        }

        /* TODO: finalize the ui and backend functionality for this */
        .container{
            overflow-y: hidden;
            overflow-x: hidden;            
        }
        

        #features_list li{
            line-height: 1.75em;
            height: auto;
            font-size: 15px;
        }

    </style>


    {% include 'landing_navbar.html' %}


    <!-- Section 1: Landing -->

    <section>

        <div class="ui two column centered grid">

            <div class="column" style="text-align: center; width: 100%;  margin-top: 1%;">

                <h1 id="landing_header" class="ui header" style="font-size: 32px; font-family: 'Raleway', sans-serif; padding-top: 0px; margin-top: 0px;">
                    Companion
                </h1>

                <span style="font-size: 14.5px;">
                    <a style="color: gray;"  id="demo_link" href="">
                        Learn More.
                    </a>
                    &nbsp;&nbsp;&nbsp;
                    <a style="color: gray;" id="demo_link" href="https://www.youtube.com/watch?v=hYPCzFBtVFE" target="_blank" rel="noopener noreferrer">
                        Watch the Full Demo.
                    </a>
                </span> 

                <p style="font-weight: 500; font-size: 17.5px; font-family: 'Raleway', sans-serif; padding-top: 12px; line-height: 1.9em;">
                    A GPT-4 based learning tutor, empowering your personalized educational journey, guiding you every step of the way.
                </p>

                <!-- <span style="font-size: 14.5px; color: gray; ">
                    <a id="demo_link" href="https://www.youtube.com/watch?v=hYPCzFBtVFE" target="_blank" rel="noopener noreferrer">
                        Learn More.
                    </a>
                    &nbsp;
                    <a id="demo_link" href="https://www.youtube.com/watch?v=hYPCzFBtVFE" target="_blank" rel="noopener noreferrer">
                        Watch the Full Demo.
                    </a>
                </span>  -->


                <!-- <div id="main-button-row" style="padding-top: 0px; ">
               
                    <div class="ui animated large black button playground_button" tabindex="0" >
                        <div class="visible content">
                            Start getting help now. 100% Free.
                        </div>
                        <div class="hidden content">
                            <i class="code icon"></i>
                        </div>
                    </div>

                    <div class="ui animated large black button playground_button" tabindex="0" >
                        <div class="visible content">
                            Are you a Teacher looking to set this up in your class?
                        </div>
                        <div class="hidden content">
                            <i class="hand point right icon"></i>
                        </div>
                    </div>

                </div> -->

                <div >
                    <a style="font-size: 14.5px;" href="">Are you a Teacher, looking to introduce a personalized tutor for your students, in your classroom?</a>
                </div>

                <!-- <div style="margin-top: 30px;">
                    <iframe width="800" height="500" src="https://www.youtube.com/embed/tgbNymZ7vqY"></iframe>
                </div> -->

            </div>

            
            <!-- Chat Section -->
            <div class="column" style="width: 75%; padding-top: 14px;">

                <h4>Try it, by asking questions below.</h4>

                <div class="chat-container" id="chat">
                        
                    <div class="message">
                        <strong>
                            Welcome! &nbsp; &#128588&nbsp;
                            I'm your personal learning assistant. 
                        </strong>
                        <br/><br/>
                        My goal is really to help you on your learning journey, whether you need help with homework or want to explore a new field.
                        <br/><br/>
                        When it comes to asking me homework questions, I will never provide you with the answer. Instead, just like a great tutor, I will
                        guide you, to help you come up with the answer on your own.
                        <br/><br/>
                        If you need help knowing where to start in a new field, feel free to ask me and I will help construct your
                        learning plan, along with any sort of questions and quizzes.
                        <br/><br/>
                        <strong>
                            Here are some things people ask me:
                        </strong>
                        <li>
                            I need to write an essay on Raskolnikov, in Crime and Punishment, specifically going through his mental state before and after he committed his crime. I need some guidance
                        </li>
                        <li>
                            What's the implementation of calculating __len__ in python, say for a string object? I need to create my own __len__ implementation, and it should be in O(1) time.
                        </li>
                        <li>
                            How is the actual list data structure implemented in python? does it use a linked list "under the hood"? How does it actually work? I need to write my own list class object for my project...
                        </li>
                        <li>
                            I have the following homework question: 
                            "I have a function where if I graph it, it form's an upside down triangle (with no base). So essentially, it's just the 2 straight lines or the sides of the triangle, without the base. Would this be considered linear (since it is straight lines and not curves) or would it be non-linear?"
                        </li>
                        <li>
                            I want to study the history of computers. Can you help develop a syllabus?
                        </li>

                    </div>
        
                    <hr>
        
                    <br/>
        
                    {% for ucs_obj in user_conversation_objects %}
                            
                        <div class="message" style="white-space: pre-line;"><b>You: </b>{{ ucs_obj.question | safe }}</div>
                        <div class="message" style="white-space: pre-line;"><b>GPT-4: </b>{{ ucs_obj.response | safe }}</div>
    
                    {% endfor %}
    
                </div>


                {% if not user_session %}

                    <div class="input-container">

                        <div class="ui form" style="width: 100%;">
                            <div class="field">
                                <textarea rows="2" id="chatInput" class="input-box form-control" placeholder="ask away..."></textarea>
                            </div>                    
                        </div>
                        &nbsp;
                        <button id="sendButton" class="ui primary button disabled send-button">Send</button>
                        <button class="ui primary loading button" id="primary_loading_button" style="display: none;">Loading</button>
            
                    </div>
            
                    <span style="font-size: 12px; color: gray; padding-bottom: 20px;">
                        Answer Response usually takes 15-30 seconds. (this will get better soon...)
                    </span>
                    <br/>
                    <span style="font-size: 12px; color: gray; padding-bottom: 20px;">
                        <a href="{% url 'login' %}">Signup</a> to save your conversations, along with uploading your files or working in our code editor environment.
                    </span>

                {% else %}

                    <p style="padding-top: 10px;">
                        Go to your <a href="{% url 'general_cs_tutor' %}">assistant page</a>
                    </p>


                {% endif %}


            </div>

        </div>

    </section>


    <!-- Divider -->
    <div class="ui vertical stripe segment" style="margin-top: 2.5%;"></div>
    

    <!-- Section 2: General About Section -->

    <div class="ui vertical stripe segment" id="second_section_main_div">
    
        <div class="ui middle aligned stackable grid container">
    
            <div class="ui centered row" id="third_section_row">

                <!-- <h2 class="ui header" id="vertical_section_header">
    
                    <div class="content" style="font-family: 'Raleway', sans-serif;">
                        What is this?
                    </div>

                </h2> -->
    
                <div class="ui basic segment" style="padding-top: 0px; margin-top: 0px;">

                    <h2 class="ui header" id="vertical_section_header">
    
                        <div class="content" style="font-family: 'Raleway', sans-serif;">
                            What's this about?
                        </div>
    
                    </h2>
    
                    <p style="line-height: 1.75em; font-size: 16px; padding-top: 10px;">
                        Companion is a GPT-4 based tutor, whose goal is to help develop your thinking, 
                        as you learn through new concepets. 
                        <br/><br/>
                        Want to learn Python? 
                        Try learning it, through some of our <a href="{% url 'practice_questions' %}">Beginner Python exercises</a>, with Companion there to help you, if needed.
                        <br/><br/>
                        <strong>
                            You can leverage Companion to: 
                        </strong>
                        <ul class="ui list" id="features_list">
                            <li>
                                Develop a study plan for a new field you are trying to learn
                            </li>
                            <li>
                                Get help thinking through a specific homework question
                            </li>
                            <li>
                                Get constant feedback on your essay, and find areas for improvement
                            </li>
                            <li>
                                Learn Programming in our <a href="{% url 'playground' %}">Online Editor</a>, with the assistant there to help
                                write and evaluate your code
                            </li>
                            <li>
                                Upload your lecture notes or problems, and ask questions on those files.
                            </li>
                        </ul>

                    </p>

                    <!-- <p style="font-size: 18px;">
                        Features:
                    </p> -->

                    <!-- <h3 class="ui header" id="vertical_section_header">
    
                        <div class="content" style="font-family: 'Raleway', sans-serif;">
                            Features:
                        </div>
    
                    </h3>

                    <ul class="ui list" style="padding-top: 10px;">
                        <li>
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                        </li>
                        <li>
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                        </li>
                        <li>
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                        </li>
                    </ul> -->

                </div>
                
            </div>
    
        </div>
    
    </div>



    <!-- Footer -->
    {% include 'landing_footer.html' %}



    <script>

        // Chat Functionality
        const chat = document.getElementById("chat");
        const chatInput = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendButton");

        sendButton.addEventListener("click", sendMessage);
        chatInput.addEventListener("keydown", (event) => {
        
            if (event.keyCode == 13 && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }

        });

        const initial_user_session = '{{ user_session }}';

        let anon_user_messages = [];
        if (initial_user_session == ''){

            let tmp_usr_messages = JSON.parse(localStorage.getItem("anon_user_messages"));

            console.log('tmp-user-messages:', tmp_usr_messages)

            if (tmp_usr_messages != null){
                anon_user_messages = tmp_usr_messages

                if (anon_user_messages.length > 0){

                    for (idx = 0; idx <= anon_user_messages.length-2; idx++){

                        // console.log(idx, idx+1)

                        let messageText = anon_user_messages[idx]
                        let model_response_message = anon_user_messages[idx+1]

                        const message = document.createElement("div");
                        message.className = "message";
                        message.innerHTML = "<b>You:</b> " + messageText;
                        message.style.whiteSpace = 'pre-wrap'
                        chat.appendChild(message);

                        const responseMessage = document.createElement("div");
                        responseMessage.className = "message";
                        responseMessage.innerHTML = "<b>GPT-4:</b> " + model_response_message;
                        // responseMessage.innerText = "<b>GPT-4:</b> " + model_response_message;
                        chat.appendChild(responseMessage);

                        // chat.scrollTop = chat.scrollHeight;

                    }

                }

            }

        }


        $("#chatInput").on('keyup', function(event) {
            
            var currentString = $("#chatInput").val()

            if (currentString.length > 0){

                $('#sendButton').removeClass('disabled');
                
            } else {
                $('#sendButton').addClass('disabled');
            }
           
        });


        function sendMessage() {

            const messageText = chatInput.value.trim();

            if (messageText !== "") {

                console.log('message-text:', messageText)

                $('#chatInput').prop('disabled', true);

                $('#sendButton').hide();
                $('#primary_loading_button').show();

                const message = document.createElement("div");
                message.className = "message";
                message.innerHTML = "<b>You:</b> " + messageText;
                message.style.whiteSpace = 'pre-wrap'
                chat.appendChild(message);

                chat.scrollTop = chat.scrollHeight;
                
                chatInput.value = "";

                let uc_parent_obj_id = $('#uc_parent_obj_id').val();
                let user_conversation_obj_id = $('#user_conversation_obj_id').val();

                let prev_conversation_history = []
                if (initial_user_session == ''){
                    // anon user, fetch messages from localstorage
                    if (anon_user_messages.length > 0){

                        prev_conversation_history = anon_user_messages.slice(0, 6)

                        // if (anon_user_messages.length > 6){

                        //     for (tidx = 1; tidx <= 6; tidx += 1){
                                
                        //         var tmp_value = anon_user_messages.length - tidx;
                        //         var tmp_st = anon_user_messages[tmp_value]
                        //         prev_conversation_history.push(tmp_st)

                        //     }

                        // } 
                        // else {

                        //     for (tidx = 1; tidx <= anon_user_messages.length; tidx += 1){
                                
                        //         var tmp_value = anon_user_messages.length - tidx;
                        //         var tmp_st = anon_user_messages[tmp_value]
                        //         prev_conversation_history.push(tmp_st)

                        //     }
                        
                        // }

                    }

                }

                let prev_conversation_history_st = ''
                if (prev_conversation_history.length > 0){
                    
                    prev_conversation_history_st = prev_conversation_history.join('\n');
                    
                }
                

                console.log('Previous Conversation History:', prev_conversation_history_st)

                let d = {
                    'message': messageText,
                    'prev_conversation_history_st': prev_conversation_history_st,
                    'uc_parent_obj_id': uc_parent_obj_id,
                    'user_ct_obj_id': user_conversation_obj_id,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                };
                
                $.ajax({
                    type: 'POST',
                    url: "{% url 'handle_general_tutor_user_message' %}",
                    dataType: "json",
                    data: d,
                    success: function (response) {

                        var model_response_dict = response['response'];
                        console.log('Response Dict:', model_response_dict)

                        var model_response_message = model_response_dict['response'];
                        model_response_message = model_response_message.replaceAll('\n', '<br/>');

                        console.log('Response:', model_response_message)

                        var user_question = model_response_dict['question'];

                        const responseMessage = document.createElement("div");
                        responseMessage.className = "message";
                        responseMessage.innerHTML = "<b>GPT-4:</b> " + model_response_message;
                        // responseMessage.innerText = "<b>GPT-4:</b> " + model_response_message;
                        chat.appendChild(responseMessage);
                        
                        chat.scrollTop = chat.scrollHeight;

                        $('#chatInput').prop('disabled', false);
                        $('#sendButton').show();
                        $('#primary_loading_button').hide();


                        var final_question_st = "Question: " + messageText
                        var final_response_st = "Response: " + model_response_message
                        anon_user_messages.push(final_question_st)
                        anon_user_messages.push(final_response_st)

                        localStorage.setItem('anon_user_messages', JSON.stringify(anon_user_messages));


                        // check if user-anon, if so:
                            // save in local storage
                            // retrieve from local storage before passing to backend

                    },
                    error: function (response) {}
                    
                });


            }

        };


    </script>



{% endblock %}


