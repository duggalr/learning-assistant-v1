{% extends 'base.html' %}
{% load static %}

{% block content %}

{% include 'app_menu.html' %}

<div class="ui grid course-outline-parent-container">

    <div class="eight wide column course-outline-parent-column">

        <!-- <h4>{{ course_object.name }}</h4>
        <p>
            {{ course_object.description }}
        </p> -->
        
        <div class="ui segment" style="padding-left: 20px; background-color: #f9f9f9;">
            <div id="content"></div>
        </div>
        
    </div>

    <div class="seven wide column ai-chat-course-outline-parent-column">

        <div class="ui tabular menu tab-menu-div">

            <a class="active item tutor-tab">
                <i class="comment icon"></i> Any Changes?
            </a>

            <!-- TODO: start here to implement this -->
            <a class="item" style="color: green;" id="course_proceed_link">
                All Good, Proceed to Course &nbsp;&nbsp;<i class="arrow right icon"></i>
            </a>

        </div>

        <!-- AI Chat -->
        <div class="ai_tutor_div" >

            <!-- Programming Assistant Tab -->
            <div id="programming_assistant_div">
                
                <div class="chat-container" id="chat">
                    
                    <div class="message">
                        So, on the right, I'm presenting a Course Outline, which I specifically generated for you,
                        based on your goals and background.
                        <br/><br/>
                        If everything looks alright, click the button above which saved "Proceed to Course".
                        <br/><br/>
                        If you want to make speciifc changes to the outline, let me know and I'd be happy
                        to make those changes!
                    </div>

                    <hr>

                    <br/>
                    {% for ucs_obj in user_conversation_objects %}
                    
                        <div class="message" style="white-space: pre-line;"><b>You: </b>{{ ucs_obj.0 | safe }}</div>
                        <div class="message" style="white-space: pre-line;"><b>GPT-4: </b>{{ ucs_obj.1 | safe }}</div>

                    {% endfor %}

                </div>

                {% if user_session is not None %}

                    <div class="input-container">
        
                        <div class="ui form" style="width: 100%;">
                            <div class="field">
                                <textarea rows="2" id="chatInput" class="input-box form-control" placeholder="ask any question..."></textarea>
                            </div>                    
                        </div>
                        &nbsp;
                        <button id="sendButton" class="ui primary button disabled send-button">Send</button>
                        <button class="ui primary loading button" id="primary_loading_button" style="display: none;">Loading</button>

                    </div>

                    <span style="font-size: 12px; color: gray; padding-bottom: 20px;">
                        Answer Response usually takes 15-30 seconds. (this will get better soon...)
                    </span>

                {% else %}

                    <div class="input-container">
        
                        <div class="ui form" style="width: 100%;">
                            <div class="field">
                                <textarea rows="2" id="chatInput" class="input-box form-control" placeholder="ask any question..."></textarea>
                            </div>                    
                        </div>
                        &nbsp;
                        <button id="sendButton" class="ui primary button disabled send-button">Send</button>
                        <button class="ui primary loading button" id="primary_loading_button" style="display: none;">Loading</button>

                    </div>

                    <span style="font-size: 12px; color: gray; padding-bottom: 20px;">
                        Answer Response usually takes 15-30 seconds. (this will get better soon...)
                    </span>

                {% endif %}

            </div>

        </div>

    </div>

</div>


<script>

    
    let course_outline_object_id = '{{ course_object.id }}';
    // console.log('cobj-id', course_outline_object_id)
    let course_outline_md = `{{ course_object.outline|safe }}`;
    document.getElementById('content').innerHTML = marked.parse(course_outline_md);

    // Global Vars
    const initial_user_session = '{{ user_session }}';
    const chat = document.getElementById("chat");
    const chatInput = document.getElementById("chatInput");
    const sendButton = document.getElementById("sendButton");


    $("#chatInput").on('keyup', function(event) {
        
        var currentString = $("#chatInput").val()

        if (currentString.length > 0){

            $('#sendButton').removeClass('disabled');
            
        } else {
            $('#sendButton').addClass('disabled');
        }
        
    });

    sendButton.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", (event) => {
    
        if (event.keyCode == 13 && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }

    });

    function sendMessage() {

        const messageText = chatInput.value.trim();

        if (messageText !== "") {

            $('#chatInput').prop('disabled', true);

            $('#sendButton').hide();
            $('#primary_loading_button').show();

            const message = document.createElement("div");
            message.className = "message";
            message.innerHTML = "<b>You:</b> " + messageText;
            message.style.whiteSpace = 'pre-wrap'
            chat.appendChild(message);

            chat.scrollTop = chat.scrollHeight;
            
            chatInput.value = "";

            let d = {
                'course_outline_object_id': course_outline_object_id,
                'message': messageText,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            };

            $.ajax({
                type: 'POST',
                url: "{% url 'student_course_outline_handle_message' %}",
                dataType: "json",
                data: d,
                success: function (response) {

                    console.log('model-response:', response);

                    // TODO: display initial message history first before proceeding and then, test below again
                    if (response['success'] == true){

                        let model_response_dict = response['response'];
                        let course_outline_text_md = model_response_dict['response']['outline'];
                        let model_response_text = model_response_dict['response']['message_to_student'];

                        const responseMessage = document.createElement("div");
                        responseMessage.className = "message";
                        responseMessage.innerHTML = "<b>GPT-4:</b> " + model_response_text ;
                        chat.appendChild(responseMessage);
    
                        chat.scrollTop = chat.scrollHeight;
                        $('#chatInput').prop('disabled', false);
                        $('#sendButton').show();
                        $('#primary_loading_button').hide();
                        document.getElementById('content').innerHTML = marked.parse(course_outline_text_md);

                    }

                },
                error: function (response) {}
                
            });

        }

    };


    $('#course_proceed_link').click(function(){

        

    });
    
</script>

{% endblock %}


